{% extends "board.html" %}

{% block PseudoSubmitForm %}{% endblock %}
{% block sidebar %}{% endblock %}
{% block navbar %}{% endblock %}
{% block sortnav %}{% endblock %}
{% block viewfilters %}{% endblock %}
{% block mobilenavbar %}{% endblock %}

{% block title %}
<title>#{{ b.name }} - Ruqqus</title>
<meta name="description" content="#{{ b.name }} chat">
{% endblock %}

{% block content %}

<div class="container p-md-0">

  <div class="page-header mt-3 mb-2">
    <span class="h3">Guild Chat</span>
    <span class="text-small-extra text-muted text-uppercase font-weight-bold">alpha</span>
  </div>
  <div id="chat-text">
  </div>

  <div class="form-group d-flex">
    <input id="guildname" type="hidden" value="{{ b.name }}">
    <input id="input-text" type="text" class="form-control" placeholder="Message +{{ b.name }} chat" autofocus />
    <button id="chatsend" class="btn btn-primary ml-3" type="submit">Send</button>
  </div>
</div>

<div id="chat-line-template" class="d-none">
  <div class="chat-line my-2">
    <div class="d-flex align-items-center">
      <span class="rounded mb-auto d-none d-md-block" style="width: 42px; height: 42px;">
        <img alt="avatar" class="desktop-avatar rounded-circle w-100">
      </span>
      <div class="pl-md-3 text-muted">
        <div>
          <img class="mobile-avatar profile-pic-30 mr-2 d-inline-block d-md-none" >
          <a href="" class="font-weight-bold text-black" target="_blank"></a>
          <div style="overflow:hidden" class="pl-4 pl-md-0 ml-4 ml-md-0">
            <span class="chat-message text-black"></span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="system-template" class="d-none">
  <div class="system-line">
    <p class="message text-muted"></p>
  </div>
</div>

<script type="text/javascript" src="/assets/js/jquery-2.0.3.min.js"></script>
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js" integrity="sha384-DkkWv9oJFWLIydBXXjkBWnG1/fuVhw8YPBq37uvvD6WSYRFRqr21eY5Dg9ZhmWdy" crossorigin="anonymous"></script>

<script>
  var socket=io();

  $('#chatsend').click(function (event) {

    if (event.which != 1) {
      return
    }
    event.preventDefault();

    console.log('clicked')

    text = $('#input-text').val()
    guild=$('#guildname').val()

    socket.emit('speak', {text: text, guild: guild});
    $('#input-text').val('')

  });

  socket.on('speak', function(json){
    console.log(json);
    username=json['username'];
    text=json['text'];
    ava=json['avatar']

    $('#chat-line-template img').attr('src', ava)
    $('#chat-line-template a').attr('href','/@'+username)
    $('#chat-line-template a').text('@'+username)
    $('#chat-line-template .chat-message').html(text)
    $('#chat-text').append($('#chat-line-template .chat-line').clone())
    window.scrollTo(0,document.body.scrollHeight)
  }
  );

  socket.on('message', function(msg){
    $('#system-template .message').text(msg)
    $('#chat-text').append($('#system-template .system-line').clone())
    window.scrollTo(0,document.body.scrollHeight)
  }
  );

  socket.on('connect',
    function(event) {
      console.log('connected, joining room')
      name=$('#guildname').val();
      socket.emit('join room', {'guild': name });
    }
    )

  document.getElementById('input-text').addEventListener("keyup", function(event) {
      // Number 13 is the "Enter" key on the keyboard
      if (event.keyCode === 13) {
        // Cancel the default action, if needed
        event.preventDefault();
        // Trigger the button element with a click
        document.getElementById("chatsend").click();
      }
    }
    )

  </script>
  {% include "expanded_image_modal.html" %}
  {% include "bootstrap.html" %}

  <script src="/assets/js/all_js.js?v=2.34.5"></script>
  {% endblock %}